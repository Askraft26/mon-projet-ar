<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Spatial Video Player - Permanent</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      #overlay {
        position: absolute; z-index: 999; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); display: flex; flex-direction: column; 
        justify-content: center; align-items: center; color: white; 
        font-family: sans-serif; cursor: pointer;
      }
      .instruction { font-size: 0.8em; margin-top: 10px; color: #ccc; }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <div id="overlay">
      <div>LANCER L'EXPÉRIENCE</div>
      <div class="instruction">Scannez le marqueur Hiro pour ancrer la vidéo</div>
    </div>

    <a-scene 
      embedded 
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="antialias: true; logarithmicDepthBuffer: true; colorManagement: true;">

      <a-assets>
        <video id="maVideo" src="V2.mp4" crossorigin="anonymous" playsinline webkit-playsinline></video>
      </a-assets>

      <a-marker preset="hiro" id="anchor-marker">
        <a-entity id="player-container" visible="false">
          
          <a-video id="video-screen" src="#maVideo" width="2" height="1.125" position="0 0.5 0"></a-video>

          <a-entity id="controls" position="0 -0.2 0.1">
            <a-box id="btn-play" class="clickable" position="0 0 0" scale="0.3 0.3 0.05" color="#4CC3D9">
              <a-text value="PLAY" align="center" position="0 0 0.6" scale="0.6 0.6 0.6"></a-text>
            </a-box>
            <a-box id="btn-back" class="clickable" position="-0.5 0 0" scale="0.3 0.3 0.05" color="#FFC65D">
              <a-text value="-5s" align="center" position="0 0 0.6" scale="0.6 0.6 0.6"></a-text>
            </a-box>
            <a-box id="btn-forward" class="clickable" position="0.5 0 0" scale="0.3 0.3 0.05" color="#FFC65D">
              <a-text value="+5s" align="center" position="0 0 0.6" scale="0.6 0.6 0.6"></a-text>
            </a-box>
          </a-entity>

        </a-entity>
      </a-marker>

      <a-entity camera>
        <a-cursor raycaster="objects: .clickable" color="#FFEB3B"></a-cursor>
      </a-entity>
    </a-scene>

    <script>
      const video = document.querySelector("#maVideo");
      const overlay = document.querySelector("#overlay");
      const marker = document.querySelector("#anchor-marker");
      const player = document.querySelector("#player-container");
      const scene = document.querySelector("a-scene");
      let isAnchored = false;

      // Déverrouillage de l'audio
      overlay.addEventListener('click', () => {
        overlay.style.display = 'none';
      });

      // LOGIQUE D'ANCRAGE PERMANENT
      marker.addEventListener('markerFound', () => {
        if (!isAnchored) {
          // 1. On capture la position et rotation actuelle du marqueur dans le monde réel
          const worldPos = new THREE.Vector3();
          const worldQuat = new THREE.Quaternion();
          const worldScale = new THREE.Vector3();
          
          marker.object3D.updateMatrixWorld();
          marker.object3D.matrixWorld.decompose(worldPos, worldQuat, worldScale);

          // 2. On déplace l'entité du marqueur vers la racine de la scène
          scene.appendChild(player);

          // 3. On applique les coordonnées mondiales pour que l'objet ne bouge pas d'un millimètre
          player.object3D.position.copy(worldPos);
          player.object3D.quaternion.copy(worldQuat);
          
          // 4. On le rend visible et on lance la vidéo
          player.setAttribute('visible', 'true');
          video.play();
          
          isAnchored = true; // On verrouille pour ne pas répéter l'opération
          console.log("Ancrage spatial activé !");
        }
      });

      // Contrôles Vidéo
      document.querySelector("#btn-play").addEventListener('click', () => {
        const txt = document.querySelector("#btn-play a-text");
        if (video.paused) {
          video.play();
          txt.setAttribute('value', 'PAUSE');
        } else {
          video.pause();
          txt.setAttribute('value', 'PLAY');
        }
      });

      document.querySelector("#btn-back").addEventListener('click', () => { video.currentTime -= 5; });
      document.querySelector("#btn-forward").addEventListener('click', () => { video.currentTime += 5; });
    </script>
  </body>
</html>
