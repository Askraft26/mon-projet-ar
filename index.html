<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>XR Player - Complete V3</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
      /* Style de l'interface utilisateur 2D */
      #overlay {
        position: absolute; z-index: 999; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); display: flex; flex-direction: column; 
        justify-content: center; align-items: center; color: white; 
        font-family: sans-serif; text-align: center; transition: opacity 0.5s;
      }
      
      #status-bar {
        position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center;
        color: lime; font-family: monospace; font-weight: bold; font-size: 1.2em;
        z-index: 10; pointer-events: none; display: none; text-shadow: 1px 1px 2px black;
      }

      #reset-btn {
        position: absolute; top: 20px; right: 20px; z-index: 20;
        background: rgba(255, 0, 0, 0.7); color: white; padding: 10px 15px;
        border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
        display: none; /* Caché au départ */
      }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden;">

    <div id="overlay">
      <h1>XR Vidéo Expérience</h1>
      <p style="margin-top:20px; color:#aaa;">Tapez pour commencer</p>
    </div>

    <div id="status-bar">Recherche du marqueur Hiro...</div>
    
    <button id="reset-btn">RE-SCANNER</button>

    <a-scene 
      embedded 
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono;"
      renderer="logarithmicDepthBuffer: true; colorManagement: true;"
      vr-mode-ui="enabled: false">

      <a-assets>
        <video id="maVideo" src="V2.mp4" crossorigin="anonymous" playsinline webkit-playsinline loop="true"></video>
      </a-assets>

      <a-marker preset="hiro" id="my-marker" emitevents="true">
        <a-plane position="0 0 0" rotation="-90 0 0" width="2.2" height="1.3" color="cyan" opacity="0.3"></a-plane>
      </a-marker>

      <a-entity id="video-rig" visible="false">
        
        <a-video src="#maVideo" width="2" height="1.125" position="0 0.6 0"></a-video>
        
        <a-entity position="0 -0.2 0.1">
          <a-box id="btn-play" class="clickable" position="0 0 0" scale="0.3 0.3 0.05" color="#4CC3D9">
             <a-text value="PLAY" align="center" position="0 0 0.6" scale="0.8 0.8 0.8"></a-text>
          </a-box>
          <a-box id="btn-back" class="clickable" position="-0.5 0 0" scale="0.3 0.3 0.05" color="#FFC65D">
            <a-text value="-5s" align="center" position="0 0 0.6" scale="0.8 0.8 0.8"></a-text>
          </a-box>
          <a-box id="btn-forward" class="clickable" position="0.5 0 0" scale="0.3 0.3 0.05" color="#FFC65D">
            <a-text value="+5s" align="center" position="0 0 0.6" scale="0.8 0.8 0.8"></a-text>
          </a-box>
        </a-entity>

      </a-entity> <a-entity camera>
        <a-cursor 
            raycaster="objects: .clickable" 
            color="#FFEB3B" 
            scale="1 1 1"
            cursor="fuse: false">
        </a-cursor>
      </a-entity>

    </a-scene>

    <script>
      // Références DOM
      const overlay = document.querySelector("#overlay");
      const statusBar = document.querySelector("#status-bar");
      const resetBtn = document.querySelector("#reset-btn");
      
      const video = document.querySelector("#maVideo");
      const marker = document.querySelector("#my-marker");
      const videoRig = document.querySelector("#video-rig");
      
      const btnPlay = document.querySelector("#btn-play");
      const btnBack = document.querySelector("#btn-back");
      const btnForward = document.querySelector("#btn-forward");
      const txtPlay = btnPlay.querySelector("a-text");

      let isLocked = false; // Est-ce que la vidéo est ancrée dans l'espace ?

      // 1. DÉMARRAGE (User Gesture)
      overlay.addEventListener('click', () => {
        overlay.style.opacity = '0';
        setTimeout(() => { overlay.style.display = 'none'; }, 500);
        
        statusBar.style.display = 'block';
        statusBar.innerText = "POINTEZ LE MARQUEUR HIRO";
        
        // On prépare la vidéo (iOS fix)
        video.play().then(() => video.pause()); 
      });

      // 2. DÉTECTION ET ANCRAGE
      marker.addEventListener('markerFound', () => {
        if (isLocked) return; // Si déjà verrouillé, on ignore

        statusBar.innerText = "MARQUEUR DÉTECTÉ ! VERROUILLAGE...";
        statusBar.style.color = "yellow";

        // Petit délai pour laisser la détection se stabiliser (500ms)
        setTimeout(() => {
          if (isLocked) return; // Sécurité

          // A. Calculer la position/rotation exacte du marqueur dans le monde 3D
          const worldPos = new THREE.Vector3();
          const worldQuat = new THREE.Quaternion();
          const worldScale = new THREE.Vector3();

          marker.object3D.updateMatrixWorld();
          marker.object3D.matrixWorld.decompose(worldPos, worldQuat, worldScale);

          // B. Appliquer ces coordonnées au "Video Rig" (qui est dans la scène, pas dans le marqueur)
          videoRig.object3D.position.copy(worldPos);
          videoRig.object3D.quaternion.copy(worldQuat);
          
          // Ajuster la rotation pour que la vidéo soit "debout" face à nous (Rotation X -90deg depuis le marqueur plat)
          videoRig.object3D.rotateX(THREE.Math.degToRad(-90));

          // C. Afficher le Rig et lancer la vidéo
          videoRig.setAttribute('visible', 'true');
          video.play();
          txtPlay.setAttribute('value', 'PAUSE');

          // D. Mise à jour de l'état
          isLocked = true;
          statusBar.innerText = "EXPÉRIENCE ACTIVE";
          statusBar.style.color = "cyan";
          resetBtn.style.display = 'block'; // Afficher le bouton reset

        }, 500);
      });

      // 3. FONCTION RESET (Pour recommencer sans recharger la page)
      resetBtn.addEventListener('click', () => {
        isLocked = false;
        videoRig.setAttribute('visible', 'false');
        video.pause();
        video.currentTime = 0;
        
        resetBtn.style.display = 'none';
        statusBar.innerText = "POINTEZ LE MARQUEUR HIRO";
        statusBar.style.color = "lime";
      });

      // 4. INTERACTION PLAY / PAUSE
      btnPlay.addEventListener('click', () => {
        if (video.paused) {
          video.play();
          txtPlay.setAttribute('value', 'PAUSE');
          btnPlay.setAttribute('color', '#4CC3D9');
        } else {
          video.pause();
          txtPlay.setAttribute('value', 'PLAY');
          btnPlay.setAttribute('color', '#EF2D5E');
        }
      });

      // Navigation
      btnBack.addEventListener('click', () => { video.currentTime -= 5; });
      btnForward.addEventListener('click', () => { video.currentTime += 5; });

      // Effet Hover sur les boutons
      document.querySelectorAll('.clickable').forEach(el => {
        el.addEventListener('mouseenter', () => {
            if(isLocked) el.object3D.scale.set(0.35, 0.35, 0.05);
        });
        el.addEventListener('mouseleave', () => {
            if(isLocked) el.object3D.scale.set(0.3, 0.3, 0.05);
        });
      });

    </script>
  </body>
</html>
